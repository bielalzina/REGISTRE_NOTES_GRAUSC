<script>
  const $welcome = document.getElementById('welcome');
  const $form = document.getElementById('student-form');
  const $message = document.getElementById('form-message');
  const $wrapper = document.getElementById('students-table-wrapper');
  const $refreshBtn = document.getElementById('refresh-btn');

  function withSuccess(fn) {
    return (data) => fn(data);
  }

  function withFailure(err) {
    console.error(err);
    alert(err.message || 'S\'ha produït un error.');
  }

  function bootstrap() {
    google.script.run
      .withSuccessHandler(
        withSuccess((data) => {
          $welcome.textContent = `Sessió iniciada com ${data.userEmail} · ${data.appVersion}`;
          loadStudents();
        })
      )
      .withFailureHandler(withFailure)
      .getBootstrapData();
  }

  function loadStudents() {
    google.script.run
      .withSuccessHandler(
        withSuccess((rows) => {
          renderStudents(rows);
        })
      )
      .withFailureHandler(withFailure)
      .listAlumnes();
  }

  function renderStudents(rows) {
    if (!rows.length) {
      $wrapper.innerHTML = '<p class="muted">Encara no hi ha alumnes registrats.</p>';
      return;
    }

    const html = `
      <table>
        <thead>
          <tr>
            <th>Document</th>
            <th>Tipus</th>
            <th>Nom</th>
            <th>1r llinatge</th>
            <th>2n llinatge</th>
          </tr>
        </thead>
        <tbody>
          ${rows
            .map(
              (r) => `
                <tr>
                  <td>${escapeHtml(r.numDocument)}</td>
                  <td>${escapeHtml(r.tipusDocument)}</td>
                  <td>${escapeHtml(r.nom)}</td>
                  <td>${escapeHtml(r.llinatge1)}</td>
                  <td>${escapeHtml(r.llinatge2 || '')}</td>
                </tr>
              `
            )
            .join('')}
        </tbody>
      </table>
    `;

    $wrapper.innerHTML = html;
  }

  function escapeHtml(value) {
    return String(value || '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  $form.addEventListener('submit', (event) => {
    event.preventDefault();

    const formData = new FormData($form);
    const payload = Object.fromEntries(formData.entries());

    $message.textContent = 'Guardant...';

    google.script.run
      .withSuccessHandler(
        withSuccess((response) => {
          $message.textContent = response.message;
          $form.reset();
          loadStudents();
        })
      )
      .withFailureHandler((err) => {
        $message.textContent = err.message || 'Error en guardar.';
      })
      .saveAlumne(payload);
  });

  $refreshBtn.addEventListener('click', loadStudents);
  bootstrap();
</script>
